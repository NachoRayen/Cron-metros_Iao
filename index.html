<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cronómetro de Bosses - Imperium AO</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet" />
  <style>
    /* ==== Estilos Globales ==== */
    body {
      margin: 0;
      padding: 2rem;
      font-family: 'MedievalSharp', cursive;
      background-color: #0a0f1a;
      color: #d0e7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.5s, color 0.5s;
      min-height: 100vh;
    }
    body.dark {
      background-color: #0a0f1a;
      color: #d0e7ff;
    }
    body.light {
      background-color: #fff;
      color: #000;
    }

    h1 {
      font-size: 2.5rem;
      color: gold;
      text-shadow: 0 0 10px #000;
      margin-bottom: 1.5rem;
      user-select: none;
    }

    /* ==== Login Form Mejorado ==== */
    #login-form {
      background: rgba(20, 30, 60, 0.9);
      border: 3px solid gold;
      border-radius: 15px;
      padding: 2rem 2.5rem;
      box-shadow: 0 0 20px gold;
      width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      user-select: none;
      position: relative;
    }

    body.light #login-form {
      background: #fefefe;
      border-color: #daa520;
      box-shadow: 0 0 15px #daa520;
      color: #222;
    }

    #login-form input[type="email"],
    #login-form input[type="password"] {
      width: 100%;
      padding: 0.7rem 1rem;
      font-size: 1.1rem;
      border: 2px solid #87cefa;
      border-radius: 8px;
      font-family: 'MedievalSharp', cursive;
      background: #0a0f1a;
      color: #d0e7ff;
      transition: border-color 0.3s, background-color 0.3s, color 0.3s;
      user-select: text;
    }

    body.light #login-form input[type="email"],
    body.light #login-form input[type="password"] {
      background: #fff;
      color: #222;
      border-color: #6699cc;
    }

    #login-form input[type="email"]::placeholder,
    #login-form input[type="password"]::placeholder {
      color: #a0c8ff;
    }

    body.light #login-form input[type="email"]::placeholder,
    body.light #login-form input[type="password"]::placeholder {
      color: #667799;
    }

    #login-form input[type="email"]:focus,
    #login-form input[type="password"]:focus {
      border-color: gold;
      outline: none;
      background-color: #112244;
      color: #ffd700;
    }

    body.light #login-form input[type="email"]:focus,
    body.light #login-form input[type="password"]:focus {
      background-color: #fffbdd;
      color: #aa7700;
    }

    #login-form button {
      width: 100%;
      background: #003366;
      color: #d0e7ff;
      border: 3px solid gold;
      padding: 0.8rem 1rem;
      font-size: 1.15rem;
      font-family: 'MedievalSharp', cursive;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s, transform 0.1s;
      user-select: none;
    }

    #login-form button:hover {
      background-color: gold;
      color: #003366;
      transform: scale(1.05);
    }

    body.light #login-form button {
      background: #f0e68c;
      color: #003366;
      border-color: #daa520;
    }

    body.light #login-form button:hover {
      background-color: #daa520;
      color: #fff;
    }

    #message {
      color: #ff6961;
      font-weight: bold;
      min-height: 1.4em;
      text-align: center;
      user-select: none;
    }

    /* ==== Pantalla de carga ==== */
    #loading-screen {
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 10, 0.8);
      color: gold;
      font-family: 'MedievalSharp', cursive;
      font-size: 1.6rem;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      border-radius: 15px;
      z-index: 10;
      display: none;
    }

    /* Ajustes logout button */
    #logout {
      margin-top: 1rem;
      background: darkred;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'MedievalSharp', cursive;
      font-weight: bold;
      transition: background-color 0.3s;
      user-select: none;
    }

    #logout:hover {
      background: red;
    }

    /* ==== Timer container ==== */
    .timer-container {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 2rem;
      max-width: 960px;
    }

    .timer {
      background: rgba(10, 20, 40, 0.85);
      border: 2px solid gold;
      border-radius: 12px;
      padding: 1rem;
      width: 270px;
      text-align: center;
      box-shadow: 0 0 15px #000;
      display: flex;
      flex-direction: column;
      user-select: none;
      transition: background-color 0.5s, border-color 0.5s;
      position: relative;
      align-items: center;
    }

    body.light .timer {
      background: #f9f9f9cc;
      border-color: #daa520;
      color: #222;
      box-shadow: 0 0 12px #daa520;
    }

    /* Estados colores */
    .timer.beforeSpawn {
      background-color: #001f3f !important; /* azul oscuro */
      border-color: #003366 !important;
    }
    body.light .timer.beforeSpawn {
      background-color: #d0e7ff !important;
      border-color: #336699 !important;
      color: #003366 !important;
    }

    .timer.canSpawn {
      background-color: #3f9fff !important; /* celeste */
      border-color: #4fc3f7 !important;
    }
    body.light .timer.canSpawn {
      background-color: #bde7ff !important;
      border-color: #3399cc !important;
      color: #005577 !important;
    }

    .timer.spawned {
      background-color: #30501a !important; /* verde */
      border-color: #a0d468 !important;
      color: #d0f0a1 !important;
    }
    body.light .timer.spawned {
      background-color: #d9f0c1 !important;
      border-color: #669933 !important;
      color: #336600 !important;
    }

    .timer h2 {
      margin-bottom: 0.3rem;
      color: #87cefa;
      user-select: text;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    body.light .timer h2 {
      color: #336699;
    }

    .respawn-time {
      font-size: 0.95rem;
      color: #ccc;
      margin-bottom: 0.5rem;
      user-select: text;
    }

    body.light .respawn-time {
      color: #555;
    }

    .timer-time {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 0.7rem;
      user-select: text;
      font-family: monospace;
    }

    .controls {
      margin-top: auto;
      display: flex;
      justify-content: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .controls button {
      background: #003366;
      color: #d0e7ff;
      border: 2px solid #87cefa;
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      font-weight: bold;
      font-family: 'MedievalSharp', cursive;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
      user-select: none;
      min-width: 90px;
    }

    .controls button:hover {
      background: #0055aa;
      transform: scale(1.05);
    }

    body.light .controls button {
      background: #f0e68c;
      color: #003366;
      border-color: #daa520;
    }

    body.light .controls button:hover {
      background: #daa520;
      color: #fff;
    }

    .warning {
      margin-top: 0.5rem;
      color: #ffae00;
      font-weight: bold;
      min-height: 1.2em;
      user-select: text;
    }

    /* ==== Ícono parpadeante ==== */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .timer-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }

    .beforeSpawn .timer-icon {
      background-color: #003366; /* azul oscuro */
    }

    .canSpawn .timer-icon {
      background-color: #4fc3f7; /* celeste */
    }

    .spawned .timer-icon {
      background-color: #4caf50; /* verde */
    }

    /* ==== Herramientas usuario ==== */
    #tools {
      margin-top: 1rem;
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      user-select: none;
    }

    #tools input[type="text"] {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 2px solid #87cefa;
      font-family: 'MedievalSharp', cursive;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      background: #0a0f1a;
      color: #d0e7ff;
      transition: border-color 0.3s;
    }

    body.light #tools input[type="text"] {
      background: #fff;
      color: #222;
      border-color: #6699cc;
    }

    #tools button {
      background: #003366;
      color: #d0e7ff;
      border: 2px solid #87cefa;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'MedievalSharp', cursive;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.1s;
    }

    #tools button:hover {
      background: #0055aa;
      transform: scale(1.05);
    }

    body.light #tools button {
      background: #f0e68c;
      color: #003366;
      border-color: #daa520;
    }

    body.light #tools button:hover {
      background: #daa520;
      color: #fff;
    }

    /* ==== Tema Claro / Oscuro ==== */
    #themeToggle {
      margin-top: 2rem;
      padding: 0.5rem 1rem;
      font-family: 'MedievalSharp', cursive;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 8px;
      border: 2px solid gold;
      background: #003366;
      color: #d0e7ff;
      user-select: none;
      transition: background-color 0.3s, color 0.3s;
      align-self: center;
    }

    #themeToggle:hover {
      background: gold;
      color: #003366;
    }

    body.light #themeToggle {
      background: #f0e68c;
      color: #003366;
      border-color: #daa520;
    }

    body.light #themeToggle:hover {
      background: #daa520;
      color: #fff;
    }

    /* ==== Input hora para "murió" ==== */
    .death-time-input {
      margin-top: 0.6rem;
      width: 70%;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      border: 2px solid #87cefa;
      font-family: monospace;
      font-size: 1rem;
      text-align: center;
      user-select: text;
      background: #0a0f1a;
      color: #d0e7ff;
      transition: border-color 0.3s;
    }

    body.light .death-time-input {
      background: #fff;
      color: #222;
      border-color: #6699cc;
    }

    /* Botón "Murió recién" */
    .btn-murio {
      margin-top: 0.6rem;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      border: 2px solid #87cefa;
      background: #003366;
      color: #d0e7ff;
      font-family: 'MedievalSharp', cursive;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s, transform 0.1s;
      width: 25%;
    }

    .btn-murio:hover {
      background: #0055aa;
      transform: scale(1.05);
    }

    body.light .btn-murio {
      background: #f0e68c;
      color: #003366;
      border-color: #daa520;
    }

    body.light .btn-murio:hover {
      background: #daa520;
      color: #fff;
    }

    /* Contenedor para input + botón */
    .input-group {
      display: flex;
      justify-content: center;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
      user-select: none;
    }
  </style>
</head>
<body class="dark">
  <h1>Cronómetro de Bosses - Imperium AO</h1>

  <div id="login-form">
    <input type="email" id="email" placeholder="Email" autocomplete="username" />
    <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" />
    <button onclick="login()">Iniciar sesión</button>
    <button onclick="register()">Registrarse</button>
    <div id="loading-screen">Cargando...</div>
    <div class="message" id="message"></div>
  </div>

  <div id="not-authorized" style="display: none;">
    No estás autorizado. Esperá a que se te apruebe el acceso.
  </div>

  <button id="logout" style="display: none;" onclick="logout()">Cerrar sesión</button>

  <!-- Herramientas usuario: Buscar, filtrar -->
  <div id="tools" style="display:none;">
    <input type="text" id="searchInput" placeholder="Buscar boss..." oninput="filterBosses()" />
  </div>

  <button id="themeToggle" style="display:none;" onclick="toggleTheme()">Cambiar a tema claro</button>

  <div class="timer-container" id="timers"></div>

  <!-- Audios para sonidos -->
  <audio id="soundSpawn" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="soundSpawned" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAizvPiX4f2hk4KFxD0J9Hm7hdfoNXz60Y",
      authDomain: "cronometroiao.firebaseapp.com",
      databaseURL: "https://cronometroiao-default-rtdb.firebaseio.com",
      projectId: "cronometroiao",
      storageBucket: "cronometroiao.appspot.com",
      messagingSenderId: "906013460712",
      appId: "1:906013460712:web:fdf87311000fc2288e615d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const timersContainer = document.getElementById("timers");
    const loginForm = document.getElementById("login-form");
    const notAuthorizedDiv = document.getElementById("not-authorized");
    const logoutBtn = document.getElementById("logout");
    const messageDiv = document.getElementById("message");
    const toolsDiv = document.getElementById("tools");
    const searchInput = document.getElementById("searchInput");
    const themeToggle = document.getElementById("themeToggle");
    const soundSpawn = document.getElementById("soundSpawn");
    const soundSpawned = document.getElementById("soundSpawned");

    // Estados y rangos en horas
    const bosses = [
      { name: "Rey Dragón", minDelay: 22, maxDelay: 30 },
      { name: "Dragón Legendario", minDelay: 16, maxDelay: 24 },
      { name: "Gran Dragón Negro", minDelay: 12, maxDelay: 20 },
      { name: "Gran Dragón Rojo", minDelay: 12, maxDelay: 20 },
      { name: "Archimago Abisal", minDelay: 9, maxDelay: 18 },
      { name: "Gran Dragón Azul", minDelay: 8, maxDelay: 14 },
      { name: "Eishner", minDelay: 9, maxDelay: 18 },
      { name: "Gran Dragón Verde", minDelay: 2, maxDelay: 5 },
      { name: "Djinn", minDelay: 7, maxDelay: 15 },
      { name: "Lilith", minDelay: 2, maxDelay: 3.5 },
      { name: "Abyssaria", minDelay: 3.5, maxDelay: 9 },
      { name: "Garveloth", minDelay: 0.5, maxDelay: 0.75 }, // 30m a 45m
      { name: "Vampiro Transformado", minDelay: 0.5, maxDelay: 0.75 } // 30m a 45m
    ];

    let userUID = null;
    let userAuthorized = false;
    let timersData = {};
    let theme = "dark";

    function setMessage(msg) {
      messageDiv.textContent = msg;
    }

    function toggleTheme() {
      if (theme === "dark") {
        theme = "light";
        document.body.classList.remove("dark");
        document.body.classList.add("light");
        themeToggle.textContent = "Cambiar a tema oscuro";
      } else {
        theme = "dark";
        document.body.classList.remove("light");
        document.body.classList.add("dark");
        themeToggle.textContent = "Cambiar a tema claro";
      }
      // Guardar preferencia en localStorage
      localStorage.setItem("theme", theme);
    }

    function applySavedTheme() {
      const saved = localStorage.getItem("theme");
      if (saved) {
        theme = saved;
      }
      if (theme === "light") {
        document.body.classList.add("light");
        themeToggle.textContent = "Cambiar a tema oscuro";
      } else {
        document.body.classList.add("dark");
        themeToggle.textContent = "Cambiar a tema claro";
      }
    }

    // LOGIN y autorización

    async function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        setMessage("Ingresá email y contraseña");
        return;
      }
      setMessage("");
      document.getElementById("loading-screen").style.display = "flex";
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        userUID = userCredential.user.uid;
        checkAuthorization();
      } catch (error) {
        setMessage("Error al iniciar sesión: " + error.message);
        document.getElementById("loading-screen").style.display = "none";
      }
    }

    async function register() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) {
        setMessage("Ingresá email y contraseña");
        return;
      }
      setMessage("");
      document.getElementById("loading-screen").style.display = "flex";
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        userUID = userCredential.user.uid;
        // En DB, crear nodo allowedUsers con false para autorización pendiente
        await database.ref("allowedUsers/" + userUID).set(false);
        setMessage("Registrado. Esperá aprobación.");
        document.getElementById("loading-screen").style.display = "none";
        logoutBtn.style.display = "inline-block";
        loginForm.style.display = "none";
      } catch (error) {
        setMessage("Error al registrar: " + error.message);
        document.getElementById("loading-screen").style.display = "none";
      }
    }

    function logout() {
      auth.signOut();
      userUID = null;
      userAuthorized = false;
      timersData = {};
      timersContainer.style.display = "none";
      loginForm.style.display = "flex";
      logoutBtn.style.display = "none";
      notAuthorizedDiv.style.display = "none";
      toolsDiv.style.display = "none";
      themeToggle.style.display = "none";
      setMessage("");
    }

    function checkAuthorization() {
      if (!userUID) return;
      // Verifica si el UID está autorizado
      const ref = database.ref("allowedUsers/" + userUID);
      ref.on("value", (snapshot) => {
        const val = snapshot.val();
        if (val === true) {
          userAuthorized = true;
          loginForm.style.display = "none";
          notAuthorizedDiv.style.display = "none";
          logoutBtn.style.display = "inline-block";
          toolsDiv.style.display = "flex";
          themeToggle.style.display = "inline-block";
          timersContainer.style.display = "flex";
          loadTimersData();
          setMessage("");
        } else {
          userAuthorized = false;
          notAuthorizedDiv.style.display = "block";
          loginForm.style.display = "none";
          logoutBtn.style.display = "inline-block";
          timersContainer.style.display = "none";
          toolsDiv.style.display = "none";
          themeToggle.style.display = "none";
          setMessage("No autorizado");
        }
        document.getElementById("loading-screen").style.display = "none";
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        userUID = user.uid;
        checkAuthorization();
      } else {
        userUID = null;
        userAuthorized = false;
        loginForm.style.display = "flex";
        logoutBtn.style.display = "none";
        timersContainer.style.display = "none";
        notAuthorizedDiv.style.display = "none";
        toolsDiv.style.display = "none";
        themeToggle.style.display = "none";
        setMessage("");
      }
    });

    // Cargar datos de timers guardados por usuario
    function loadTimersData() {
      if (!userUID) return;
      const ref = database.ref("timers/" + userUID);
      ref.on("value", (snapshot) => {
        timersData = snapshot.val() || {};
        renderTimers();
      });
    }

    // Guardar datos en DB
    function saveTimerData(bossName, deathTimeISO) {
      if (!userUID) return;
      if (!timersData) timersData = {};
      timersData[bossName] = deathTimeISO;
      database.ref("timers/" + userUID).set(timersData);
    }

    // Crear y mostrar los timers
    function renderTimers() {
      timersContainer.innerHTML = "";
      bosses.forEach((boss) => {
        const container = document.createElement("div");
        container.className = "timer beforeSpawn";
        container.id = "timer-" + boss.name.replace(/\s+/g, "-").toLowerCase();

        // Título boss con icono parpadeante
        const h2 = document.createElement("h2");
        h2.textContent = boss.name;
        const icon = document.createElement("span");
        icon.className = "timer-icon";
        h2.appendChild(icon);
        container.appendChild(h2);

        // Info rango spawn
        const respawnRange = document.createElement("div");
        respawnRange.className = "respawn-time";
        respawnRange.textContent = `Respawn: ${formatDelay(boss.minDelay)} a ${formatDelay(boss.maxDelay)}`;
        container.appendChild(respawnRange);

        // Tiempo restante display
        const timerTime = document.createElement("div");
        timerTime.className = "timer-time";
        timerTime.textContent = "00:00:00";
        container.appendChild(timerTime);

        // Input para "murió" (hora ISO, fecha y hora local)
        const inputGroup = document.createElement("div");
        inputGroup.className = "input-group";

        const deathInput = document.createElement("input");
        deathInput.type = "datetime-local";
        deathInput.className = "death-time-input";
        deathInput.title = "Hora de muerte del boss";
        deathInput.step = "60"; // solo minutos
        deathInput.value = "";

        const btnMurio = document.createElement("button");
        btnMurio.className = "btn-murio";
        btnMurio.textContent = "Murió recién";
        btnMurio.title = "Marcar muerte en este momento";

        inputGroup.appendChild(deathInput);
        inputGroup.appendChild(btnMurio);

        container.appendChild(inputGroup);

        // Guardar referencias para actualización
        container._timerTime = timerTime;
        container._deathInput = deathInput;

        // Cargar valor guardado en input si existe
        if (timersData[boss.name]) {
          // timersData guarda ISO string, convertir a formato datetime-local
          const d = new Date(timersData[boss.name]);
          // Ajustar a local, formatear "YYYY-MM-DDTHH:mm"
          const localISO = d.toISOString().slice(0,16);
          deathInput.value = localISO;
        }

        // Evento input cambio manual
        deathInput.addEventListener("change", () => {
          if (deathInput.value) {
            const isoString = new Date(deathInput.value).toISOString();
            saveTimerData(boss.name, isoString);
          } else {
            // borrar timer guardado
            if (timersData[boss.name]) {
              delete timersData[boss.name];
              database.ref("timers/" + userUID).set(timersData);
            }
          }
        });

        // Evento botón murio recién
        btnMurio.addEventListener("click", () => {
          const now = new Date();
          // Ajustar a formato datetime-local "YYYY-MM-DDTHH:mm"
          const pad = (n) => n.toString().padStart(2, "0");
          const localStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
          deathInput.value = localStr;
          const isoString = now.toISOString();
          saveTimerData(boss.name, isoString);
        });

        timersContainer.appendChild(container);
      });
      updateTimers();
    }

    // Función para formatear delays en horas y minutos
    function formatDelay(hours) {
      if (hours < 1) {
        return `${Math.round(hours * 60)}m`;
      } else if (Number.isInteger(hours)) {
        return `${hours}h`;
      } else {
        // Ejemplo 3.5 = 3h 30m
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${h}h ${m}m`;
      }
    }

    // Actualiza todos los timers y su estado
    function updateTimers() {
      const now = new Date();

      bosses.forEach((boss) => {
        const container = document.getElementById("timer-" + boss.name.replace(/\s+/g, "-").toLowerCase());
        if (!container) return;

        const deathISO = timersData[boss.name];
        const deathDate = deathISO ? new Date(deathISO) : null;

        const minDelayMs = boss.minDelay * 3600 * 1000;
        const maxDelayMs = boss.maxDelay * 3600 * 1000;

        let elapsed = deathDate ? now - deathDate : null;

        // Estados y colores
        // beforeSpawn: no pasó minDelay aún
        // canSpawn: entre minDelay y maxDelay (puede spawnear)
        // spawned: pasó maxDelay (ya spawneó)
        let state = "beforeSpawn";
        let timeToShow = 0;

        if (!deathDate) {
          // No murió aún, tiempo completo para spawn
          state = "beforeSpawn";
          timeToShow = boss.minDelay * 3600 * 1000;
        } else if (elapsed < minDelayMs) {
          state = "beforeSpawn";
          timeToShow = minDelayMs - elapsed;
        } else if (elapsed >= minDelayMs && elapsed < maxDelayMs) {
          state = "canSpawn";
          timeToShow = maxDelayMs - elapsed;
        } else {
          state = "spawned";
          timeToShow = 0;
        }

        // Actualizar clase del timer
        container.classList.remove("beforeSpawn", "canSpawn", "spawned");
        container.classList.add(state);

        // Mostrar cronómetro siempre
        container._timerTime.textContent = formatMsToHHMMSS(timeToShow);

        // Para estado spawned poner 00:00:00
        if (state === "spawned") {
          container._timerTime.textContent = "00:00:00";
        }
      });
    }

    // Formatea milisegundos a HH:MM:SS
    function formatMsToHHMMSS(ms) {
      if (ms < 0) ms = 0;
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    }

    // Filtrar bosses por texto
    function filterBosses() {
      const text = searchInput.value.toLowerCase();
      bosses.forEach((boss) => {
        const el = document.getElementById("timer-" + boss.name.replace(/\s+/g, "-").toLowerCase());
        if (!el) return;
        if (boss.name.toLowerCase().includes(text)) {
          el.style.display = "flex";
        } else {
          el.style.display = "none";
        }
      });
    }

    // Actualizar timers cada 10 segundos
    setInterval(() => {
      if (userAuthorized) {
        updateTimers();
      }
    }, 10000);

    // Aplicar tema guardado y listo
    applySavedTheme();

  </script>
</body>
</html>
