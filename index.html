<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Boss Timers</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: white;
    }
    .light {
      background-color: #f0f0f0;
      color: black;
    }
    #loading-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      z-index: 9999;
    }
    .timer {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin: 8px;
      background-color: #1e1e1e;
      width: 260px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .spawning {
      background-color: #333;
    }
    .spawned {
      background-color: #2e7d32;
    }
    .input-group {
      margin-top: 8px;
    }
    .input-group input {
      margin-right: 8px;
    }
    #tools {
      display: flex;
      justify-content: space-between;
      margin: 10px;
      align-items: center;
    }
    #themeToggle {
      margin-left: auto;
    }
    #timers {
      display: none;
      flex-wrap: wrap;
      padding: 10px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="loading-screen">Cargando...</div>

  <div id="login-form">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Contraseña" />
    <button onclick="login()">Iniciar sesión</button>
    <button onclick="register()">Registrarse</button>
    <div id="message"></div>
  </div>

  <div id="not-authorized" style="display: none;">No estás autorizado para acceder.</div>

  <div id="tools" style="display: none;">
    <input type="text" id="searchInput" placeholder="Buscar boss" oninput="filterBosses()" />
    <button id="themeToggle" onclick="toggleTheme()">Cambiar a tema claro</button>
    <button id="logout" onclick="logout()">Cerrar sesión</button>
  </div>

  <div id="timers"></div>

  <audio id="soundSpawn" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
  <audio id="soundSpawned" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAizvPiX4f2hk4KFxD0J9Hm7hdfoNXz60Y",
      authDomain: "cronometroiao.firebaseapp.com",
      databaseURL: "https://cronometroiao-default-rtdb.firebaseio.com",
      projectId: "cronometroiao",
      storageBucket: "cronometroiao.appspot.com",
      messagingSenderId: "906013460712",
      appId: "1:906013460712:web:fdf87311000fc2288e615d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const timersContainer = document.getElementById("timers");
    const loginForm = document.getElementById("login-form");
    const notAuthorizedDiv = document.getElementById("not-authorized");
    const messageDiv = document.getElementById("message");
    const logoutButton = document.getElementById("logout");
    const toolsDiv = document.getElementById("tools");
    const themeToggleBtn = document.getElementById("themeToggle");
    const searchInput = document.getElementById("searchInput");
    const loadingScreen = document.getElementById("loading-screen");

    const bosses = [
      { name: "Rey Dragón", min: 22 * 60, max: 30 * 60 },
      { name: "Dragón Legendario", min: 16 * 60, max: 24 * 60 },
      { name: "Gran Dragón Negro", min: 12 * 60, max: 20 * 60 },
      { name: "Gran Dragón Rojo", min: 12 * 60, max: 20 * 60 },
      { name: "Archimago Abisal", min: 9 * 60, max: 18 * 60 },
      { name: "Gran Dragón Azul", min: 8 * 60, max: 14 * 60 },
      { name: "Eishner", min: 9 * 60, max: 18 * 60 },
      { name: "Gran Dragón Verde", min: 2 * 60, max: 5 * 60 },
      { name: "Djinn", min: 7 * 60, max: 15 * 60 },
      { name: "Lilith", min: 2 * 60, max: 3 * 60 + 30 },
      { name: "Abyssaria", min: 3 * 60 + 30, max: 9 * 60 },
      { name: "Garveloth", min: 30, max: 45 },
      { name: "Vampiro Transformado", min: 30, max: 45 },
    ];

    function formatMinutes(mins) {
      const h = Math.floor(mins / 60);
      const m = Math.round(mins % 60);
      return `${h > 0 ? h + "h " : ""}${m > 0 ? m + "m" : ""}`.trim() || "0m";
    }

    function formatDateForInput(date) {
      const pad = (n) => n.toString().padStart(2, "0");
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    let currentUser = null;

    // --- LOGIN ---
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      if (!email || !password) {
        messageDiv.textContent = "Por favor, ingresa email y contraseña.";
        return;
      }
      loadingScreen.style.display = "flex";
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          messageDiv.textContent = "";
          loadingScreen.style.display = "none";
        })
        .catch((error) => {
          messageDiv.textContent = "Error al iniciar sesión: " + error.message;
          loadingScreen.style.display = "none";
        });
    }

    // --- REGISTER ---
    function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      if (!email || !password) {
        messageDiv.textContent = "Por favor, ingresa email y contraseña.";
        return;
      }
      loadingScreen.style.display = "flex";
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          messageDiv.textContent = "Usuario registrado correctamente. Ahora inicia sesión.";
          loadingScreen.style.display = "none";
        })
        .catch((error) => {
          messageDiv.textContent = "Error al registrarse: " + error.message;
          loadingScreen.style.display = "none";
        });
    }

    // --- LOGOUT ---
    function logout() {
      auth.signOut();
    }

    // --- AUTH STATE CHANGED ---
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      if (user) {
        loginForm.style.display = "none";
        notAuthorizedDiv.style.display = "none";
        toolsDiv.style.display = "flex";
        timersContainer.style.display = "flex";
        loadTimers();
      } else {
        loginForm.style.display = "block";
        notAuthorizedDiv.style.display = "none";
        toolsDiv.style.display = "none";
        timersContainer.style.display = "none";
        clearTimers();
      }
    });

    // --- LOAD TIMERS ---
    function loadTimers() {
      loadingScreen.style.display = "flex";
      database.ref("timers").once("value")
        .then((snapshot) => {
          const timersData = snapshot.val() || {};
          renderTimers(timersData);
          loadingScreen.style.display = "none";
        })
        .catch(() => {
          loadingScreen.style.display = "none";
        });
    }

    // --- CLEAR TIMERS ---
    function clearTimers() {
      timersContainer.innerHTML = "";
    }

    // --- RENDER TIMERS ---
    function renderTimers(timersData) {
      timersContainer.innerHTML = "";
      bosses.forEach((boss) => {
        const timerData = timersData[boss.name] || {};
        createTimerElement(boss, timerData);
      });
    }

    // --- CREATE TIMER ELEMENT ---
    function createTimerElement(boss, timerData) {
      const div = document.createElement("div");
      div.classList.add("timer");
      div.id = "timer-" + boss.name.replace(/\s+/g, "-");

      // Estado y color
      if (timerData.spawnedAt) {
        div.classList.add("spawned");
      } else if (timerData.spawningAt) {
        div.classList.add("spawning");
      }

      // Nombre
      const title = document.createElement("h3");
      title.textContent = boss.name;
      div.appendChild(title);

      // Estado texto
      const status = document.createElement("p");
      status.id = `status-${boss.name.replace(/\s+/g, "-")}`;
      div.appendChild(status);

      // Input fecha/hora de spawn
      const inputGroup = document.createElement("div");
      inputGroup.classList.add("input-group");
      const input = document.createElement("input");
      input.type = "datetime-local";
      input.value = timerData.spawnedAt ? formatDateForInput(new Date(timerData.spawnedAt)) : "";
      input.id = `input-${boss.name.replace(/\s+/g, "-")}`;
      inputGroup.appendChild(input);

      // Botones
      const btnSpawn = document.createElement("button");
      btnSpawn.textContent = "Spawn";
      btnSpawn.onclick = () => markSpawn(boss.name);

      const btnSpawned = document.createElement("button");
      btnSpawned.textContent = "Spawned";
      btnSpawned.onclick = () => markSpawned(boss.name);

      inputGroup.appendChild(btnSpawn);
      inputGroup.appendChild(btnSpawned);
      div.appendChild(inputGroup);

      timersContainer.appendChild(div);

      // Actualizar estado y timer
      updateTimer(boss, timerData);
    }

    // --- MARCAR SPAWN ---
    function markSpawn(bossName) {
      const input = document.getElementById(`input-${bossName.replace(/\s+/g, "-")}`);
      const spawnTime = new Date(input.value).getTime();
      if (isNaN(spawnTime)) {
        alert("Por favor, ingresa una fecha/hora válida para spawn.");
        return;
      }
      database.ref(`timers/${bossName}`).update({
        spawningAt: spawnTime,
        spawnedAt: null,
      });
      playSound("soundSpawn");
      loadTimers();
    }

    // --- MARCAR SPAWNED ---
    function markSpawned(bossName) {
      const input = document.getElementById(`input-${bossName.replace(/\s+/g, "-")}`);
      const spawnedTime = new Date(input.value).getTime();
      if (isNaN(spawnedTime)) {
        alert("Por favor, ingresa una fecha/hora válida para spawned.");
        return;
      }
      database.ref(`timers/${bossName}`).update({
        spawnedAt: spawnedTime,
        spawningAt: null,
      });
      playSound("soundSpawned");
      loadTimers();
    }

    // --- REPRODUCIR SONIDO ---
    function playSound(id) {
      const sound = document.getElementById(id);
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }

    // --- ACTUALIZAR TIMER ---
    function updateTimer(boss, timerData) {
      const statusP = document.getElementById(`status-${boss.name.replace(/\s+/g, "-")}`);
      if (!statusP) return;

      if (timerData.spawnedAt) {
        // Spawned: mostrar countdown
        const spawnedAt = timerData.spawnedAt;
        const now = Date.now();
        const minSeconds = boss.min * 1000;
        const maxSeconds = boss.max * 1000;

        let diff = now - spawnedAt;
        let timeLeftMin = (minSeconds - diff) / 1000;
        let timeLeftMax = (maxSeconds - diff) / 1000;

        if (timeLeftMax < 0) {
          statusP.textContent = "Boss disponible";
          statusP.style.color = "#2e7d32";
        } else if (timeLeftMin < 0) {
          statusP.textContent = `Probable spawn entre 0m y ${formatMinutes(timeLeftMax / 60)}`;
          statusP.style.color = "#f39c12";
        } else {
          statusP.textContent = `Probable spawn entre ${formatMinutes(timeLeftMin / 60)} y ${formatMinutes(timeLeftMax / 60)}`;
          statusP.style.color = "#f39c12";
        }
      } else if (timerData.spawningAt) {
        statusP.textContent = "Boss en proceso de spawn...";
        statusP.style.color = "#999";
      } else {
        statusP.textContent = "Sin datos de spawn";
        statusP.style.color = "#777";
      }
    }

    // --- FILTRAR BOSSES ---
    function filterBosses() {
      const filter = searchInput.value.toLowerCase();
      bosses.forEach((boss) => {
        const timerDiv = document.getElementById(`timer-${boss.name.replace(/\s+/g, "-")}`);
        if (!timerDiv) return;
        if (boss.name.toLowerCase().includes(filter)) {
          timerDiv.style.display = "flex";
        } else {
          timerDiv.style.display = "none";
        }
      });
    }

    // --- TOGGLE THEME ---
    function toggleTheme() {
      document.body.classList.toggle("light");
      if (document.body.classList.contains("light")) {
        themeToggleBtn.textContent = "Cambiar a tema oscuro";
      } else {
        themeToggleBtn.textContent = "Cambiar a tema claro";
      }
    }

    // --- ACTUALIZAR CADA SEGUNDO LOS TIMERS ---
    setInterval(() => {
      if (!currentUser) return;
      database.ref("timers").once("value").then((snapshot) => {
        const timersData = snapshot.val() || {};
        bosses.forEach((boss) => {
          updateTimer(boss, timersData[boss.name] || {});
        });
      });
    }, 1000);

  </script>
</body>

</html>
