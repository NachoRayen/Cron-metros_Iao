<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cronómetro Respawn Bosses</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 1rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #boss-list {
      list-style: none;
      padding: 0;
    }
    #boss-list li {
      display: flex;
      justify-content: space-between;
      padding: 0.3rem 0;
      border-bottom: 1px solid #ddd;
      align-items: center;
    }
    button {
      cursor: pointer;
      margin-left: 0.5rem;
    }
    input {
      margin: 0.3rem 0;
      padding: 0.3rem;
      width: 100%;
      box-sizing: border-box;
    }
    form {
      margin-top: 1rem;
    }
    @media (max-width: 500px) {
      body {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Cronómetro Respawn Bosses</h1>
    <div id="user-info"></div>
    <button id="btn-logout" hidden>Salir</button>
  </header>

  <section id="auth-section">
    <h2>Ingresar</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contraseña" />
    <button id="btn-login">Entrar</button>
    <button id="btn-register">Registrarse</button>
    <div id="auth-msg" style="color:red; margin-top:0.5rem;"></div>
  </section>

  <section id="app-section" hidden>
    <h2>Bosses</h2>
    <ul id="boss-list"></ul>

    <form id="add-boss-form">
      <input id="new-boss-name" placeholder="Nuevo boss" required />
      <input id="new-boss-time" type="number" placeholder="Respawn min (ej: 30)" required min="1" />
      <button>Agregar Boss</button>
    </form>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      onSnapshot,
      updateDoc,
      query,
      orderBy,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Config Firebase (reemplaza con la tuya si querés)
    const firebaseConfig = {
      apiKey: "AIzaSyAizvPiX4f2hk4KFxD0J9Hm7hdfoNXz60Y",
      authDomain: "cronometroiao.firebaseapp.com",
      databaseURL: "https://cronometroiao-default-rtdb.firebaseio.com",
      projectId: "cronometroiao",
      storageBucket: "cronometroiao.appspot.com",
      messagingSenderId: "906013460712",
      appId: "1:906013460712:web:fdf87311000fc2288e615d",
      measurementId: "G-K923BGRD3K",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userInfo = document.getElementById("user-info");
    const btnLogout = document.getElementById("btn-logout");
    const authSection = document.getElementById("auth-section");
    const appSection = document.getElementById("app-section");
    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const btnLogin = document.getElementById("btn-login");
    const btnRegister = document.getElementById("btn-register");
    const authMsg = document.getElementById("auth-msg");

    const bossList = document.getElementById("boss-list");
    const addBossForm = document.getElementById("add-boss-form");
    const newBossName = document.getElementById("new-boss-name");
    const newBossTime = document.getElementById("new-boss-time");

    let unsubscribeBosses = null;

    function showAuthMsg(msg) {
      authMsg.textContent = msg;
      setTimeout(() => (authMsg.textContent = ""), 4000);
    }

    btnLogin.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passInput.value.trim();
      if (!email || !password) return showAuthMsg("Completa email y contraseña");
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        showAuthMsg(e.message);
      }
    });

    btnRegister.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passInput.value.trim();
      if (!email || !password) return showAuthMsg("Completa email y contraseña");
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (e) {
        showAuthMsg(e.message);
      }
    });

    btnLogout.addEventListener("click", () => {
      signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userInfo.textContent = `Hola, ${user.email}`;
        btnLogout.hidden = false;
        authSection.hidden = true;
        appSection.hidden = false;
        startListeningBosses(user.uid);
      } else {
        userInfo.textContent = "";
        btnLogout.hidden = true;
        authSection.hidden = false;
        appSection.hidden = true;
        if (unsubscribeBosses) unsubscribeBosses();
        bossList.innerHTML = "";
      }
    });

    function createBossItem(id, data, userId) {
      const li = document.createElement("li");

      const span = document.createElement("span");
      span.textContent = `${data.name} - Respawn: ${data.respawnMinutes} min`;

      const btnStart = document.createElement("button");
      btnStart.textContent = "Iniciar respawn";
      btnStart.onclick = () => startRespawn(id);

      const btnDelete = document.createElement("button");
      btnDelete.textContent = "Borrar";
      btnDelete.onclick = async () => {
        if (confirm(`Borrar boss "${data.name}"?`)) {
          await deleteDoc(doc(db, "bosses", id));
        }
      };

      li.appendChild(span);
      li.appendChild(btnStart);

      if (data.createdBy === userId) {
        li.appendChild(btnDelete);
      }

      if (data.startedAt) {
        const startedAtMs = data.startedAt.seconds * 1000; // Firestore timestamp
        const diff = (Date.now() - startedAtMs) / 60000;
        const left = Math.max(data.respawnMinutes - diff, 0);
        const timerSpan = document.createElement("span");
        timerSpan.textContent = ` - Quedan ${left.toFixed(1)} min`;
        timerSpan.style.marginLeft = "0.5rem";
        li.appendChild(timerSpan);

        if (left <= 0) {
          li.style.color = "green";
          notifyUser(`¡Boss ${data.name} listo para respawnear!`);
        }
      }

      return li;
    }

    function startListeningBosses(userId) {
      if (unsubscribeBosses) unsubscribeBosses();

      const q = query(collection(db, "bosses"), orderBy("name"));
      unsubscribeBosses = onSnapshot(q, (snapshot) => {
        bossList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const bossData = docSnap.data();
          bossList.appendChild(createBossItem(docSnap.id, bossData, userId));
        });
      });
    }

    async function startRespawn(bossId) {
      await updateDoc(doc(db, "bosses", bossId), {
        startedAt: new Date(),
      });
    }

    addBossForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = newBossName.value.trim();
      const respawnMinutes = Number(newBossTime.value);
      const user = auth.currentUser;
      if (!name || !respawnMinutes || !user) return;

      await addDoc(collection(db, "bosses"), {
        name,
        respawnMinutes,
        startedAt: null,
        createdBy: user.uid,
      });

      addBossForm.reset();
    });

    function notifyUser(msg) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification(msg);
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") new Notification(msg);
        });
      }
    }
  </script>
</body>
</html>
